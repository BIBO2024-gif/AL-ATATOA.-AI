<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al- Atatoa.Ai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // This script is to load Lucide icons via CDN for direct use in HTML
        const lucideScript = document.createElement('script');
        lucideScript.src = 'https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js';
        document.head.appendChild(lucideScript);

        const G_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-5 h-5 fill-current"><path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z" /></svg>`;

        let auth, db, userId;
        let isAuthReady = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        document.addEventListener('DOMContentLoaded', async () => {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const setupAuth = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                }
            };

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('user-id').textContent = userId;
                    attachFirestoreListener();
                } else {
                    await setupAuth();
                }
            });

            document.getElementById('send-btn').addEventListener('click', handleSendMessage);
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });
        });

        const getCollectionPath = (appId) => {
            return `artifacts/${appId}/public/data/chat_messages`;
        };

        const attachFirestoreListener = () => {
            const q = query(
                collection(db, getCollectionPath(appId)),
                orderBy('timestamp')
            );
            onSnapshot(q, (querySnapshot) => {
                const messages = [];
                querySnapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                renderMessages(messages);
                scrollToBottom();
            }, (error) => {
                console.error("Error fetching messages: ", error);
            });
        };

        const renderMessages = (messages) => {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            if (messages.length === 0) {
                container.innerHTML = `<div class="flex justify-center items-center h-full text-gray-500 italic">Start a conversation to see messages here.</div>`;
            } else {
                messages.forEach(message => {
                    const isUser = message.userId === userId;
                    const messageClass = isUser ? 'justify-end' : 'justify-start';
                    const messageBg = isUser ? 'bg-blue-500 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none';
                    const senderText = isUser ? 'You' : message.sender === 'user' ? `User: ${message.userId}` : 'Gemini';
                    const avatar = isUser ? 
                        `<div class="flex-shrink-0"><div class="bg-slate-700 rounded-full p-2 text-white shadow-lg">${G_ICON_SVG}</div></div>` :
                        `<div class="flex-shrink-0"><div class="${message.sender === 'user' ? 'bg-blue-500' : 'bg-slate-700'} rounded-full p-2 text-white shadow-lg">${message.sender === 'user' ? '<lucide-icon name="graduation-cap" class="w-5 h-5"></lucide-icon>' : '<lucide-icon name="bot" class="w-5 h-5"></lucide-icon>'}</div></div>`;

                    const messageHTML = `
                        <div class="flex items-start gap-4 p-4 ${messageClass}">
                            ${!isUser ? avatar : ''}
                            <div class="flex flex-col p-4 rounded-xl max-w-[70%] shadow-lg ${messageBg}">
                                <div class="text-xs opacity-75 ${isUser ? 'text-right' : 'text-left'}">${senderText}</div>
                                <p class="whitespace-pre-wrap">${message.text}</p>
                            </div>
                            ${isUser ? avatar : ''}
                        </div>
                    `;
                    container.innerHTML += messageHTML;
                });
            }
        };

        const scrollToBottom = () => {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        };

        const callGeminiAPI = async (chatHistory) => {
            const payload = {
                contents: [{ parts: [{ text: chatHistory }] }],
                systemInstruction: {
                    parts: [{ text: "You are a friendly and knowledgeable AI assistant. Keep your responses concise and helpful." }]
                },
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const retryFetch = async (url, options, retries = 3, delay = 1000) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return retryFetch(url, options, retries - 1, delay * 2);
                    } else {
                        throw error;
                    }
                }
            };

            try {
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";
                return text;
            } catch (error) {
                console.error("API call failed:", error);
                return "An error occurred. Please try again later.";
            }
        };

        const handleSendMessage = async () => {
            const inputElement = document.getElementById('message-input');
            const input = inputElement.value.trim();
            if (input === '' || !isAuthReady || !userId) return;

            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');

            const userMessage = {
                text: input,
                sender: 'user',
                userId: userId,
                timestamp: serverTimestamp(),
            };
            try {
                await addDoc(collection(db, getCollectionPath(appId)), userMessage);
                inputElement.value = '';

                const geminiResponse = await callGeminiAPI(input);

                const botMessage = {
                    text: geminiResponse,
                    sender: 'bot',
                    userId: 'gemini',
                    timestamp: serverTimestamp(),
                };
                await addDoc(collection(db, getCollectionPath(appId)), botMessage);
            } catch (e) {
                console.error("Error adding document: ", e);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100">
    <header class="flex items-center justify-between p-4 bg-white shadow-md">
        <h1 class="text-2xl font-bold text-gray-800">Al- Atatoa.Ai</h1>
        <div class="text-sm text-gray-500">
          Your User ID: <span id="user-id">Authenticating...</span>
        </div>
    </header>

    <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="flex justify-center items-center h-full text-gray-500 italic">
            Start a conversation to see messages here.
        </div>
    </div>
    
    <div id="loading-indicator" class="hidden flex justify-center items-center p-4">
        <div class="flex space-x-2 animate-pulse">
            <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
            <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
            <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
        </div>
    </div>

    <div class="p-4 bg-white border-t border-gray-200">
        <div class="flex space-x-2">
            <input
                id="message-input"
                type="text"
                class="flex-1 p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                placeholder="Type your message..."
            />
            <button
                id="send-btn"
                class="p-3 rounded-full text-white transition-all transform hover:scale-105 shadow-md bg-blue-600 hover:bg-blue-700"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizonal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
            </button>
        </div>
    </div>
</body>
</html>
